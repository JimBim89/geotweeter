<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Fabians Geotweeter</title>
<link rel="stylesheet" type="text/css" href="style.css" />
<script src="oauth.js"></script>
<script src="sha1.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script type="text/javascript">
var url = "https://userstream.twitter.com/2/user.json";
//var url = "http://stream.twitter.com/1/statuses/sample.json";
var accessor = {
    token: "15006408-BtuU3rI0K0FGI8cnIpa5YYZHNpSNWDJScCD9x4Gdn",
    tokenSecret: "9j5hKhm8J5ewdGOkQDyCgxj526mKZWnN0XY7hwDpDk",
    consumerKey: "mjVYJfHrlqzKOXdLKEMXA",
    consumerSecret: "kU0tDiwAZkehi03wHHHp9B7EZI7fnxV0eawLVSmw"
}

var places = [
    {name:"--leer--",  lat:0.0000000, lon:0.000000},
    {name:"Zu Hause",  lat:51.446646, lon:7.646494, place_id:"c2a82d0b6fbcde87"}, // "Letteweg"
    {name:"Papi",      lat:51.520870, lon:8.532433, place_id:"12b809c9f5071d62"}, // "Siddinghausen, Büren, Paderborn"
    {name:"Arbeit",    lat:51.483685, lon:7.411289, place_id:"d423ae4220494dff"}, // "GB5, Uni..."
    {name:"GB5 R.334", lat:51.483721, lon:7.410863, place_id:"d423ae4220494dff"}, // "GB5, Uni..."
    {name:"OH 14",     lat:51.489777, lon:7.406346, place_id:"ad78499b8383b454"}, // "OH14"
    {name:"UFC",       lat:51.484404, lon:7.416725, place_id:"564a7c397c5583ff"}, // "Pav. 4"
];

var message = {
    action: url,
    method: "GET",
    parameters: {delimited: "length", include_entities: "1", include_rts: "1"}
}

var chars = "™☹☺☠☐☑☒♻⚠⏳⏰⏱♫";

var responseOffset = 0;
var buffer = "";
var isProcessing = false;
var reply_to_user = null;
var reply_to_id = null;
var maxreadid = 0;
var maxknownid = 0;
var minknownid = 0;
var delay = 2;
var mindelay = 2;
var maxPages = 2;
var maxdelay = 160;
var connectionStartedAt = new Date();
var disconnectBecauseOfTimeout = false;
var lastDataReceivedAt = null;
var goDownTo = null;

regexp_url = /((https?:\/\/)(([^ :]+(:[^ ]+)?@)?[a-z0-9]([a-z0-9i\-]{0,61}[a-z0-9])?(\.[a-z0-9]([a-z0-9\-]{0,61}[a-z0-9])?){0,32}\.[a-z]{2,5}(\/[^ \"@]*[^" \.,;\)@])?))/ig;
regexp_user = /(^|\s)@([a-zA-Z0-9_]+)/g;
regexp_hash = /(^|\s)#([\wäöüÄÖÜß]+)/g;
regexp_cache = /(^|\s)(GC[A-Z1-9]+)/g;


$(document).ready(start);

function start() {
    // Fill Form
    for(var i=0; i<places.length; i++) {
        document.tweet_form.place.options[document.tweet_form.place.length] = new Option(places[i].name, i);
    }
    for(var i=0; i<chars.length; i++) {
        $('#chars').append('<a href="#" onClick="$(\'#text\').append(\'' + chars[i] + '\');">' + chars[i] + '</a>');
    }

    maxreadid = parseInt(getMaxReadID());
    startRequest();

    updateCounter();

    window.setInterval("checkForTimeout()", 30000);
}

function checkForTimeout() {
    var jetzt = new Date();
    if (lastDataReceivedAt && jetzt.getTime() - lastDataReceivedAt.getTime() > 45000) {
        disconnectBecauseOfTimeout = true;
        req.abort();
    }
}

function fillList() {
    $('#status').find("*").hide();
    $('#status #filling').show();
    var page = 1;
    while ((minknownid==0 || maxreadid < minknownid) && page <= maxPages) {
        var parameters = {include_rts: "1", count: "500", page: page};
        if (maxknownid > 0)
            parameters.since_id = maxknownid;
        var message = {
            action: "https://api.twitter.com/1/statuses/home_timeline.json",
            method: "GET",
            parameters: parameters
        }
        OAuth.setTimestampAndNonce(message);
        OAuth.completeRequest(message, accessor);
        OAuth.SignatureMethod.sign(message, accessor);
        var url = 'home_timeline_proxy?' + OAuth.formEncode(message.parameters);
        var returned = $.ajax({
            url: url,
            type: "GET",
            async: false,
            dataType: "text"
        }).responseText;
        parseData(returned);
        page += 1;
    }
}
    
function startRequest() {
    fillList();

    OAuth.setTimestampAndNonce(message);
    OAuth.completeRequest(message, accessor);
    OAuth.SignatureMethod.sign(message, accessor);
    var url = 'user_proxy?' + OAuth.formEncode(message.parameters);
    //url = 'https://amazonas.f00bian.de/twitter.stream/sample_proxy?' + OAuth.formEncode(message.parameters);
    //$("#content").html($('#content').html() + url + '<hr />');
    //return;
    
    $('#status').find('*').hide();
    $('#status #connecting').show();

    disconnectBecauseOfTimeout = false;

    req = new XMLHttpRequest();
    req.open('GET', url, true);
    req.onreadystatechange = parseResponse;
    req.send(null);
}

function parseResponse(event) {
    if (event.target.readyState == 1) {
        connectionStartedAt = new Date();
    } else if (event.target.readyState == 4) {
        $('#status').find('*').hide();
        $('#status #disconnected').show();
        var jetzt = new Date();
        if (jetzt.getTime() - connectionStartedAt.getTime() > 10000)
            delay = mindelay;
        var html = '<div class="status">Disconnect. ';
        if (disconnectBecauseOfTimeout) {
            html += 'Grund: Timeout. ';
        }
        if (event.target.status != 200) {
            html += 'Status: ' + event.target.status + ' (' + event.target.statusText + '). ';
            delay = maxdelay;
        }
        addHTML(html + 'Nächster Versuch in ' + delay + ' Sekunden.</div>');
        window.setTimeout('startRequest()', delay*1000);
        if (delay*2 <= maxdelay)
            delay = delay * 2;
    } else if (event.target.readyState == 3) {
        $('#status').find('*').hide();
        $('#status #connected').show();
        lastDataReceivedAt = new Date();
    }
    buffer += event.target.responseText.substr(responseOffset);
    responseOffset = event.target.responseText.length;
    if (!isProcessing) processBuffer();
}

function processBuffer() {
    isProcessing = true;
    reg = /^[\r\n]*([0-9]+)\r\n([\s\S]+)$/;
    while(res = buffer.match(reg)) {
        len = parseInt(res[1]);
        if (res[2].length >= len) {
            parseableText = res[2].substr(0, len);
            buffer = res[2].substr(len);
            parseData(parseableText);
        } else {
            break;
        }
    }
    isProcessing = false;
}

function parseData(data) {
    try {
        var message = eval('(' + data + ')');
    } catch (e) {
        addHTML("Exception: " + e + '<br />' + data + '<hr />');
    }
    if (message.constructor.toString().indexOf('Array')!=-1) {
        var html = '';
        for(var i=0; i<message.length; i++) {
            if (message[i]) html += addStatus(message[i], false);
        }
        addHTML(html);
        return;
    }

    if (message==null)
        return; // Fix for NULLs in stream

    if (message.text) {
        addStatus(message);
    } else if (message.friends) {
        twitter_friends = message.friends;
    } else if (message.delete) {
        // Deletion-Request. Do nothing ,-)
    } else if (message.direct_message) {
        addStatus(message);
    } else if (message.event && message.event=="follow") {
        // Social Event.
        addFollowEvent(message);
    } else {
        addHTML('<hr />Unbekannte Daten:<br />' + data);
    }
}

function addHTML(text) {
    $('#content').html(text + $('#content').html());
}

function addFollowEvent(event) {
    if (event.source.screen_name=="fabianonline") return;
    var html = "";
    html += '<div class="status">';
    html += '<span class="avatar">';
    html += '<a href="http://twitter.com/account/profile_image/' + event.source.screen_name + '"><img class="user_avatar" src="' + event.source.profile_image_url + '" /></a>';
    html += '</span>';
    html += 'Neuer Follower: ';
    html += '<span class="poster">';
    html += '<a href="http://twitter.com/' + event.source.screen_name + '">' + event.source.screen_name + '</a> (' + event.source.name + ')';
    html += '</span>';
    html += '</div>';
    addHTML(html);
}

function addStatus(status, addHTMLToPage) {
    isDM = false;
    if (status.direct_message) {
        isDM = true;
        status = status.direct_message;
    }
    if (addHTMLToPage !== false)
        addHTMLToPage = true;
    var html = "";
    var user;
    if (status.retweeted_status)
        user = status.retweeted_status.user.screen_name;
    else if (isDM)
        user = status.sender.screen_name;
    else
        user = status.user.screen_name;

    if (!isDM && status.id > maxknownid)
        maxknownid = status.id;
    if (!isDM && (minknownid==0 || status.id < minknownid))
        minknownid = status.id;

    var date = new Date(status.created_at);
    var datum = addnull(date.getDate()) + '.' + addnull(date.getMonth()+1) + '.' + (date.getYear()+1900) + ' ' + addnull(date.getHours()) + ':' + addnull(date.getMinutes());
    html += '<div class="';
    if (!isDM)
        html += 'tweet ';
    else
        html += 'dm ';
    html += 'by_' + user;
    if (!isDM && status.id > maxreadid)
        html += ' new';
    var mentions = status.text.match(regexp_user);
    if (mentions) for (var i=0; i<mentions.length; i++) {
        html += ' mentions_' + mentions[i].trim().substr(1) + ' ';
    }
    html += '">';
    html += '<a name="status_' + status.id + '" />';
    html += '<span class="avatar">';
    html += '<a href="http://twitter.com/account/profile_image/' + user + '"><img class="user_avatar" src="';
    if (status.retweeted_status)
        html += status.retweeted_status.user.profile_image_url;
    else if (isDM)
        html += status.sender.profile_image_url;
    else
        html += status.user.profile_image_url;
    html += '" /></a>';
    html += '</span>';
    html += '<span class="poster">';
    html += '<a href="http://twitter.com/' + user + '">' + user + '</a>';
    html += '</span>';
    html += '<span class="text">';
    if (status.retweeted_status)
        html += linkify(status.retweeted_status.text);
    else
        html += linkify(status.text);
    html += '</span>';
    if (status.retweeted_status)
        html += '<div class="retweet_info">Retweeted by <a href="http://twitter.com/' + status.user.screen_name + '">' + status.user.screen_name + '</a></div>';
    if (status.place)
        html += '<div class="place">from ' + status.place.full_name + '</div>';
    html += '<div class="info">';
    html += datum + ' ';
    if(status.in_reply_to_status_id)
        html += '<a href="http://twitter.com/' + status.in_reply_to_screen_name + '/status/' + status.in_reply_to_status_id + '" target="_blank">in reply to...</a> ';
    if (status.source)
        html += 'from ' + status.source + ' ';
    if (status.coordinates) {
        html += '<a href="http://maps.google.com/?q=' + status.coordinates.coordinates[1] + ',' + status.coordinates.coordinates[0] + '" target="_blank">geo</a> ';
        html += '<a href="http://maps.google.com/?q=http%3A%2F%2Fapi.twitter.com%2F1%2Fstatuses%2Fuser_timeline%2F' + user + '.atom%3Fcount%3D250">all geo</a> ';
    }
    html += '</div>';

    html += '<div class="links">';
    if (isDM)
        html += '<a href="#" onClick="replyToTweet(' + status.id + ', \'' + user + '\', true); return true;">Reply</a> ';
    else
        html += '<a href="#" onClick="replyToTweet(' + status.id + ', \'' + user + '\'); return true;">Reply</a> ';
    if (!isDM)
        html += '<a href="#" onClick="retweet(' + status.id + '); return true;">Retweet</a> ';
    if (!isDM)
        html += '<a href="#" onClick="quote(' + status.id + ', \'' + user + '\', \'' + escape(status.text.split('"').join('').split('@').join('')) + '\'); return true;">Quote</a> ';
    html += '<a href="http://translate.google.de/#auto|de|' + escape(status.text.split('"').join('').split('@').join('')) + '" target="_blank">Translate</a> ';

    html += '</div>';
    html += '</div>';
    if (!addHTMLToPage)
        return html;
    addHTML(html);
}

function addnull(number) {
    if (number<10)
        return "0" + number;
    return number;
}

function linkify(text) {
    text = text.replace(regexp_url, '<a href="$1" target="_blank">$1</a>');
    text = text.replace(regexp_user, '$1@<a href="http://twitter.com/$2" target="_blank">$2</a>');
    text = text.replace(regexp_hash, '$1<a href="http://twitter.com/search?q=#$2" target="_blank">#$2</a>');
    text = text.replace(regexp_cache, '$1<a href="http://coord.info/$2" target="_blank">$2</a>');
    text = text.replace(/\n/g, '<br />\n');
    return text;
}

function sendTweet() {
    var parameters = {status: $('#text').val()};
    if(document.tweet_form.place.options[0].selected && !confirm('Kein Ort gesetzt. Wirklich ohne Koordinaten tweeten?'))
        return;
    placeIndex = document.tweet_form.place.value;
    if(placeIndex > 0) {
        parameters.lat = places[placeIndex].lat + (((Math.random()*300)-15)*0.000001);
        parameters.lon = places[placeIndex].lon + (((Math.random()*300)-15)*0.000001);
        if (places[placeIndex].place_id)
            parameters.place_id = places[placeIndex].place_id;
        parameters.display_coordinates = "true";
    }
    if (document.tweet_form.reply_to_id.value != "")
        parameters.in_reply_to_status_id = document.tweet_form.reply_to_id.value;

    var message = {
        action: "https://api.twitter.com/1/statuses/update.json",
        method: "POST",
        parameters: parameters
    }

    $('#form').fadeTo(500, 0).delay(500);
    
    OAuth.setTimestampAndNonce(message);
    OAuth.completeRequest(message, accessor);
    OAuth.SignatureMethod.sign(message, accessor);
    var url = 'statuses_update_proxy';
    var data = OAuth.formEncode(message.parameters);

    $.ajax({
        url: url,
        data: data,
        dataType: "json",
        type: "POST",
        success: function(data, textStatus, req) {
            if (data.text) {
                //$('#counter').html(data + textStatus);
                var html = 'Tweet-ID: ' + data.id + '<br />';
                html += 'Mein Tweet Nummer: ' + data.user.statuses_count + '<br />';
                html += 'Follower: ' + data.user.followers_count + '<br />';
                html += 'Friends:' + data.user.friends_count + '<br />';

                $('#success_info').html(html);
                $('#success').fadeIn(500).delay(2000).fadeOut(500, function() {
                    $('#form').fadeTo(500, 1);
                });
            } else {
                $('#failure_info').html(data.error);
                $('#failure').fadeIn(500).delay(2000).fadeOut(500, function() {
                    $('#form').fadeTo(500, 1);
                });
            }
            $('#text').val('');
            reply_to_user = null;
            reply_to_id = null;
            updateCounter();
        },
        error: function(req, testStatus, exc) {
            $('#failure_info').html('Error ' + req.status + ' (' + req.statusText + ')');
            $('#failure').fadeIn(500).delay(2000).fadeOut(500, function() {
                $('#form').fadeTo(500, 1);
            });
        }
   });
}

function retweet(id) {
    if (!confirm('Wirklich direkt retweeten?'))
        return false;

    var parameters = {id: id};

    var message = {
        action: "https://api.twitter.com/1/statuses/retweet.json",
        method: "POST",
        parameters: parameters
    }

    $('#form').fadeTo(500, 0).delay(500);
    
    OAuth.setTimestampAndNonce(message);
    OAuth.completeRequest(message, accessor);
    OAuth.SignatureMethod.sign(message, accessor);
    var url = 'statuses_retweet_proxy';
    var data = OAuth.formEncode(message.parameters);

    $.ajax({
        url: url,
        data: data,
        dataType: "json",
        type: "POST",
        success: function(data, textStatus, req) {
            if (data.status) {
                $('#success_info').html("Retweet successful");
                $('#success').fadeIn(500).delay(5000).fadeOut(500, function() {
                    $('#form').fadeTo(500, 1);
                });
            } else {
                $('#failure_info').html(data.error);
                $('#failure').fadeIn(500).delay(2000).fadeOut(500, function() {
                    $('#form').fadeTo(500, 1);
                });
            }
            updateCounter();
        },
        error: function(req, testStatus, exc) {
            $('#failure_info').html('Error ' + req.status + ' (' + req.statusText + ')');
            $('#failure').fadeIn(500).delay(2000).fadeOut(500, function() {
                $('#form').fadeTo(500, 1);
            });
        }
   });
}

function quote(tweet_id, user, text) {
    text = 'RT @' + user + ': ' + unescape(text);
    reply_to_user = user;
    reply_to_id = tweet_id;
    $('#text').val(text).focus();
    $('#reply_to_id').val(tweet_id);
    updateCounter();
}

function replyToTweet(tweet_id, user, isDM) {
    reply_to_user = user;
    reply_to_id = tweet_id;
    if (isDM===true)
        $('#text').val('d ' + user + ' ').focus();
    else
        $('#text').val('@' + user + ' ').focus();
    $('#reply_to_id').val(tweet_id);
    setGoDownTo('status_' + tweet_id);
    updateCounter();
}

function updateCounter() {
    var text = $('#text').val();
    $('#counter').html( 140-text.length );

    if (reply_to_id != null) {
        var re = new RegExp("(^| )@" + reply_to_user + "([\.:, ]|$)");
        if (re.test(text)) {
            $('#reply_warning').fadeOut();
        } else {
            $('#reply_warning').fadeIn();
        }
    } else {
        $('#reply_to_id').val('');
        $('#reply_warning').fadeOut();
    }
}

function removeReplyWarning() {
    $('#reply_to_id').val('');
    $('#reply_warning').fadeOut();
    reply_to_user = null;
    reply_to_id = null;
}

function getMaxReadID() {
    return $.ajax({
        method: 'GET',
        url: 'getmaxreadid.php',
        async: false,
        dataType: 'text'
    }).responseText;
}

function setMaxReadID(id) {
    $.ajax({
        method: 'GET',
        url: 'setmaxreadid.php',
        async: false,
        dataType: 'text',
        data: {id: id}
    });
}

function markAllRead() {
    if (maxknownid > 0)
        setMaxReadID(maxknownid);
    maxreadid = maxknownid;
    $('.new').removeClass('new');
}

function setGoDownTo(hash) {
    goDownTo = hash;
    $('#godown').display();
}

function goDown() {
    self.location = '#' + goDownTo;
    goDownTo = null;
    $('#godown').hide();
}
</script>
</head>

<body>
<div id="status">
    <div id="connected">Connected</div>
    <div id="connecting">Connecting...</div>
    <div id="filling">Filling list...</div>
    <div id="disconnected">Disconnected</div>
</div>
<div id="buttonbar">
    <a href="#" onClick="req.abort();"><img src="icons/action_refresh.gif" title="Verbindung neu aufbauen." /></a>
    <a href="#" onClick="markAllRead();"><img src="icons/icon_accept.gif" title="Alle als gelesen markieren." /></a>
    <a href="#" onClick="$('#chars').toggle(500);"><img src="icons/file_font_truetype.gif" title="Sonderzeichen einfügen" /></a>
    <a href="#" onClick="location.reload();"><img src="icons/action_refresh_blue.gif" title="App neu starten." /></a>
    <a href="#" onClick="goDown(); return false;">Go down</a>
</div>
<div id="chars"></div>
<!-- <a href="#" onClick="req.abort(); return false;">Abbrechen</a> -->
<div id="reply_warning">Achtung, dieser Tweet ist kein Reply mehr. <a href="#" onClick="removeReplyWarning();">Er soll auch kein Reply sein.</a></div>
<div id="form_area">
<form name="tweet_form" id="form">
    <select name="place" id="place"></select>
    <span id="counter"></span>
    <input type="submit" onClick="sendTweet(); return false;" value="Tweet" /><br />

    <textarea name="text" rows="5" cols="80" id="text" onKeyUp="updateCounter();"></textarea>
    <input type="hidden" name="reply_to_id" id="reply_to_id" value="" />
</form>
<div id="success">
    <h1>OK</h1>
    <div id="success_info"></div>
</div>
<div id="failure">
    <h1>FEHLER</h1>
    <div id="failure_info"></div>
</div>
</div>

<div id="content"></div>
<!-- <a href="#" onClick="req.abort(); return false;">Abbrechen</a> -->
</body>
</html>

