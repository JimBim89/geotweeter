<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Twitter.Stream</title>
<link rel="stylesheet" type="text/css" href="style.css" />
<script src="oauth.js"></script>
<script src="sha1.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script type="text/javascript">
var url = "https://betastream.twitter.com/2b/user.json";
//var url = "http://stream.twitter.com/1/statuses/sample.json";
var accessor = {
    token: "15006408-BtuU3rI0K0FGI8cnIpa5YYZHNpSNWDJScCD9x4Gdn",
    tokenSecret: "9j5hKhm8J5ewdGOkQDyCgxj526mKZWnN0XY7hwDpDk",
    consumerKey: "mjVYJfHrlqzKOXdLKEMXA",
    consumerSecret: "kU0tDiwAZkehi03wHHHp9B7EZI7fnxV0eawLVSmw"
}

var places = [
    {name:"--leer--", lat:0.0, lon:0.0},
    {name:"Zu Hause", lat:51.446646, lon:7.646494}
];

var message = {
    action: url,
    method: "GET",
    parameters: {delimited: "length", include_entities: "1", include_rts: "1"}
}

responseOffset = 0;
buffer = "";
isProcessing = false;

regexp_url = /((https?:\/\/)(([^ :]+(:[^ ]+)?@)?[a-z0-9]([a-z0-9i\-]{0,61}[a-z0-9])?(\.[a-z0-9]([a-z0-9\-]{0,61}[a-z0-9])?){0,32}\.[a-z]{2,5}(\/[^ ]*[^" \.,;\)])?))/ig;
regexp_user = /(^|\s)@(\w+)/g;
regexp_hash = /(^|\s)#([\wäöüÄÖÜß]+)/g;


$(document).ready(start);

function start() {
    startRequest();

    // Fill Form
    for(var i=0; i<places.length; i++) {
        document.tweet_form.place.options[document.tweet_form.place.length] = new Option(places[i].name, i);
    }
}

function startRequest() {
    OAuth.setTimestampAndNonce(message);
    OAuth.completeRequest(message, accessor);
    OAuth.SignatureMethod.sign(message, accessor);
    var url = 'https://amazonas.f00bian.de/twitter.stream/user_proxy?' + OAuth.formEncode(message.parameters);
    //url = 'https://amazonas.f00bian.de/twitter.stream/sample_proxy?' + OAuth.formEncode(message.parameters);
    //$("#content").html($('#content').html() + url + '<hr />');
    //return;

    $('#status #connected').hide();
    $('#status #disconnected').hide();
    $('#status #connecting').show();

    req = new XMLHttpRequest();
    req.open('GET', url, true);
    req.onreadystatechange = parseResponse;
    req.send(null);
}

function parseResponse(event) {
    if (event.target.readyState == 4) {
        $('#status #connected').hide();
        $('#status #connecting').hide();
        $('#status #disconnected').show();
        window.setTimeout('startRequest()', 5000);
    } else if (event.target.readyState == 3) {
        $('#status #connected').show();
        $('#status #connecting').hide();
        $('#status #disconnected').hide();
    }
    buffer += event.target.responseText.substr(responseOffset);
    responseOffset = event.target.responseText.length;
    if (!isProcessing) processBuffer();
}

function processBuffer() {
    isProcessing = true;
    reg = /^[\r\n]*([0-9]+)\r\n([\s\S]+)$/;
    while(res = buffer.match(reg)) {
        len = parseInt(res[1]);
        if (res[2].length >= len) {
            parseableText = res[2].substr(0, len);
            buffer = res[2].substr(len);
            parseData(parseableText);
        } else {
            break;
        }
    }
    isProcessing = false;
}

function parseData(data) {
    try {
        var message = eval('(' + data + ')');

        if (message.text) {
            addStatus(message);
        } else if (message.friends) {
            twitter_friends = message.friends;
        } else if (message.delete) {
            // Deletion-Request. Do nothing ,-)
        /*else if (message.direct_message) {
            // DM. Do something!
        } else if (message.event) {
            // Social Event. Perhaps do something?*/
        } else {
            addHTML(data + "<hr />");
        }
    } catch (e) {
        addHTML("Exception: " + e);
    }
}

function addHTML(text) {
    $('#content').html(text + $('#content').html());
}

function addStatus(status) {
    var html = "";
    var user;
    if (status.retweeted_status)
        user = status.retweeted_status.user.screen_name;
    else
        user = status.user.screen_name;

    var date = new Date(status.created_at);
    var datum = date.getDate() + '.' + (date.getMonth()+1) + '.' + date.getYear() + ' ' + date.getHours() + ':' + date.getMinutes();
    html += '<div class="tweet new  by_' + user;
    var mentions = status.text.match(regexp_user);
    if (mentions) for (var i=0; i<mentions.length; i++) {
        html += ' mentions_' + mentions[i].trim().substr(1) + ' ';
    }
    html += '">';
    html += '<span class="avatar">';
    html += '<a href="http://twitter.com/account/profile_image/' + user + '"><img class="user_avatar" src="';
    if (status.retweeted_status)
        html += status.retweeted_status.user.profile_image_url;
    else
        html += status.user.profile_image_url;
    html += '" /></a>';
    html += '</span>';
    html += '<span class="poster">';
    html += '<a href="http://twitter.com/' + user + '">' + user + '</a>';
    html += '</span>';
    html += '<span class="text">';
    html += linkify(status.text);
    html += '</span>';
    html += '<div class="info">';
    html += datum + ' ';
    if(status.retweeted_status)
        html += 'Retweeted by ' + status.user.screen_name + ' ';
    if(status.in_reply_to_status_id)
        html += '<a href="http://twitter.com/' + status.in_reply_to_screen_name + '/status/' + status.in_reply_to_status_id + ' target="_blank">in reply to...</a> ';
    html += 'from ' + status.source + ' ';
    if (status.coordinates) {
        html += '<a href="http://maps.google.com/?q=' + status.coordinates.coordinates[1] + ',' + status.coordinates.coordinates[0] + '" target="_blank">geo</a> ';
        html += '<a href="http://maps.google.com/?q=http%3A%2F%2Fapi.twitter.com%2F1%2Fstatuses%2Fuser_timeline%2F' + user + '.atom%3Fcount%3D250">all geo</a> ';
    }
    html += '</div>';
    html += '</div>';
    addHTML(html);
}

function linkify(text) {
    text = text.replace(regexp_url, '<a href="$1" target="_blank">$1</a>');
    text = text.replace(regexp_user, '$1@<a href="http://twitter.com/$2" target="_blank">$2</a>');
    text = text.replace(regexp_hash, '$1<a href="http://twitter.com/search?q=#$2" target="_blank">#$2</a>');
    return text;
}

function sendTweet() {
    var parameters = {status: $('#text').val()};
    if(document.tweet_form.place.options[0].selected && !confirm('Kein Ort gesetzt. Wirklich ohne Koordinaten tweeten?'))
        return;
    placeIndex = document.tweet_form.place.value;
    if(placeIndex > 0) {
        parameters.lat = places[placeIndex].lat;
        parameters.lon = places[placeIndex].lon;
    }

    var message = {
        action: "https://api.twitter.com/1/statuses/update.json",
        method: "POST",
        parameters: parameters
    }

    $('#form').fadeTo(500, 0).delay(500);
    
    OAuth.setTimestampAndNonce(message);
    OAuth.completeRequest(message, accessor);
    OAuth.SignatureMethod.sign(message, accessor);
    var url = 'https://amazonas.f00bian.de/twitter.stream/statuses_update_proxy';
    var data = OAuth.formEncode(message.parameters);

    $.ajax({
        url: url,
        data: data,
        dataType: "json",
        type: "POST",
        success: function(data, textStatus, req) {
            if (data.text) {
                //$('#counter').html(data + textStatus);
                var html = 'Tweet-ID: ' + data.id + '<br />';
                html += 'Mein Tweet Nummer: ' + data.user.statuses_count + '<br />';
                html += 'Follower: ' + data.user.followers_count + '<br />';
                html += 'Friends:' + data.user.friends_count + '<br />';

                $('#success_info').html(html);
                $('#success').fadeIn(500).delay(5000).fadeOut(500, function() {
                    $('#form').fadeTo(500, 1);
                });
            } else {
                $('#form').fadeIn();
            }
        },
        error: function() {
            $('#failure').fadeIn(500).delay(2000).fadeOut(500, function() {
                $('#form').fadeTo(500, 1);
            });
        }
   });

}
</script>
</head>

<body>
<!-- <a href="#" onClick="req.abort(); return false;">Abbrechen</a> -->
<div id="form_area">
<form name="tweet_form" id="form">
    <select name="place" id="place"></select>
    <span id="counter"></span>
    <input type="submit" onClick="sendTweet(); return false;" value="Tweet" /><br />

    <textarea name="text" rows="5" cols="80" id="text"></textarea>
</form>
<div id="success">
    <h1>OK</h1>
    <div id="success_info"></div>
</div>
<div id="failure">
    <h1>FEHLER</h1>
</div>
</div>

<div id="status">
    <div id="connected">Connected</div>
    <div id="connecting">Connecting...</div>
    <div id="disconnected">Disconnected</div>
</div>
<div id="content"></div>
<!-- <a href="#" onClick="req.abort(); return false;">Abbrechen</a> -->
</body>
</html>

