<!DOCTYPE html>  <html> <head>   <title>class.account.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="_info.html">                 _info.coffee               </a>                                           <a class="source" href="class.account.html">                 class.account.coffee               </a>                                           <a class="source" href="class.directmessage.html">                 class.directmessage.coffee               </a>                                           <a class="source" href="class.event.html">                 class.event.coffee               </a>                                           <a class="source" href="class.hooks.html">                 class.hooks.coffee               </a>                                           <a class="source" href="class.pullrequest.html">                 class.pullrequest.coffee               </a>                                           <a class="source" href="class.request.html">                 class.request.coffee               </a>                                           <a class="source" href="class.streamrequest.html">                 class.streamrequest.coffee               </a>                                           <a class="source" href="class.thumbnail.html">                 class.thumbnail.coffee               </a>                                           <a class="source" href="class.tweet.html">                 class.tweet.coffee               </a>                                           <a class="source" href="class.twittermessage.html">                 class.twittermessage.coffee               </a>                                           <a class="source" href="class.user.html">                 class.user.coffee               </a>                                           <a class="source" href="extension.date.html">                 extension.date.coffee               </a>                                           <a class="source" href="extension.number.html">                 extension.number.coffee               </a>                                           <a class="source" href="extension.string.html">                 extension.string.coffee               </a>                                           <a class="source" href="geotweeter.html">                 geotweeter.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               class.account.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Account maps to a single Twitter Account with its keys and so on</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Account</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Account.first is a shortcut for developing: <code>Account.first</code> is much 
easier to type on the console than <code>Application.accounts[0]</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="vi">@first: </span><span class="kc">null</span>
	
	<span class="nv">screen_name: </span><span class="s2">&quot;unknown&quot;</span>
	<span class="nv">max_read_id: </span><span class="s2">&quot;0&quot;</span>
	<span class="nv">max_known_tweet_id: </span><span class="s2">&quot;0&quot;</span>
	<span class="nv">max_known_dm_id: </span><span class="s2">&quot;0&quot;</span>
	<span class="nv">my_last_tweet_id: </span><span class="s2">&quot;0&quot;</span>
	<span class="nv">tweets: </span><span class="p">{}</span>
	<span class="nv">id: </span><span class="kc">null</span>
	<span class="nv">user: </span><span class="kc">null</span>
	<span class="nv">request: </span><span class="kc">null</span>
	<span class="nv">keys: </span><span class="p">{}</span>
	<span class="nv">followers_ids: </span><span class="p">[]</span>
	<span class="nv">status_text: </span><span class="s2">&quot;&quot;</span>
	</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>The constructor is called by Application. <code>settings_id</code> is the id of
this account as it appears in <code>settings.twitter.user</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">constructor: </span><span class="nf">(settings_id) -&gt;</span>
		<span class="nx">@id</span><span class="o">=</span><span class="nx">settings_id</span>
		<span class="nv">Account.first = </span><span class="k">this</span> <span class="k">if</span> <span class="nx">settings_id</span><span class="o">==</span><span class="mi">0</span>
		<span class="vi">@keys = </span><span class="p">{</span>
			<span class="nv">consumerKey: </span><span class="nx">settings</span><span class="p">.</span><span class="nx">twitter</span><span class="p">.</span><span class="nx">consumerKey</span>
			<span class="nv">consumerSecret: </span><span class="nx">settings</span><span class="p">.</span><span class="nx">twitter</span><span class="p">.</span><span class="nx">consumerSecret</span>
			<span class="nv">token: </span><span class="nx">settings</span><span class="p">.</span><span class="nx">twitter</span><span class="p">.</span><span class="nx">users</span><span class="p">[</span><span class="nx">settings_id</span><span class="p">].</span><span class="nx">token</span>
			<span class="nv">tokenSecret: </span><span class="nx">settings</span><span class="p">.</span><span class="nx">twitter</span><span class="p">.</span><span class="nx">users</span><span class="p">[</span><span class="nx">settings_id</span><span class="p">].</span><span class="nx">tokenSecret</span>
		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Clone the template-content-area so this account has it's own content
area.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">new_area = </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#content_template&#39;</span><span class="p">).</span><span class="nx">clone</span><span class="p">()</span>
		<span class="nx">new_area</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nx">@get_content_div_id</span><span class="p">())</span>
		<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">new_area</span><span class="p">);</span>
		<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#users&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;</span>
<span class="s2">			&lt;div class=&#39;user&#39; id=&#39;user_#{@id}&#39; data-account-id=&#39;#{@id}&#39;&gt;</span>
<span class="s2">				&lt;a href=&#39;#&#39; onClick=&#39;return Account.hooks.change_current_account(this);&#39;&gt;</span>
<span class="s2">					&lt;img src=&#39;icons/spinner.gif&#39; /&gt;</span>
<span class="s2">					&lt;span class=&#39;count&#39;&gt;&lt;/span&gt;</span>
<span class="s2">				&lt;/a&gt;</span>
<span class="s2">			&lt;/div&gt;</span>
<span class="s2">		&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Add a tooltip to this account's selector button at the top of the screen.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#user_#{@id}&quot;</span><span class="p">).</span><span class="nx">tooltip</span><span class="p">({</span>
			<span class="nv">bodyHandler: </span><span class="o">=&gt;</span> <span class="s2">&quot;&lt;strong&gt;@#{@screen_name}&lt;/strong&gt;&lt;br /&gt;#{@status_text}&quot;</span>
			<span class="nv">track: </span><span class="kc">true</span>
			<span class="nv">showURL: </span><span class="kc">false</span>
			<span class="nv">left: </span><span class="mi">5</span>
		<span class="p">})</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Initialize an adequate Stream object.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="vi">@request = </span><span class="k">if</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">twitter</span><span class="p">.</span><span class="nx">users</span><span class="p">[</span><span class="nx">settings_id</span><span class="p">].</span><span class="nx">stream</span><span class="o">?</span> <span class="k">then</span> <span class="k">new</span> <span class="nx">StreamRequest</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="k">else</span> <span class="k">new</span> <span class="nx">PullRequest</span><span class="p">(</span><span class="k">this</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Try to validate the keys and get informations about this account.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">@validate_credentials</span><span class="p">()</span>
		</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Returns the jQuery element of the content area of this account.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">get_my_element: </span><span class="o">-&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#content_#{@id}&quot;</span><span class="p">)</span>
	</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Saves the given <code>id</code> to Tweetmarker.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">set_max_read_id: </span><span class="nf">(id) -&gt;</span> 
		<span class="nx">unless</span> <span class="nx">id</span><span class="o">?</span>
			<span class="nx">Application</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">&quot;set_max_read_id&quot;</span><span class="p">,</span> <span class="s2">&quot;Falscher Wert: #{id}&quot;</span><span class="p">)</span>
			<span class="k">return</span>
		
		<span class="vi">@max_read_id = </span><span class="nx">id</span>
		</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Tweetmarker uses Oauth echo: To verify our identity, we generate
valid OAuth credentials for our twitter account and send those to
Tweetmarker. They can use them and identify us.
This method is safe: The generated credentials can only be used once
and only for verify_credentials.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">header = </span><span class="p">{</span>
			<span class="s2">&quot;X-Auth-Service-Provider&quot;</span><span class="o">:</span> <span class="s2">&quot;https://api.twitter.com/1/account/verify_credentials.json&quot;</span>
			<span class="s2">&quot;X-Verify-Credentials-Authorization&quot;</span><span class="o">:</span> <span class="nx">@sign_request</span><span class="p">(</span><span class="s2">&quot;https://api.twitter.com/1/account/verify_credentials.json&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="nv">return_type: </span><span class="s2">&quot;header&quot;</span><span class="p">})</span>
		<span class="p">}</span>
		</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>We are lazy and send the same id for timeline and mentiions collection.
Oh, and please note the super secret api key...</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
			<span class="nv">type: </span><span class="s1">&#39;POST&#39;</span>
			<span class="nv">url: </span><span class="s2">&quot;proxy/tweetmarker/lastread?collection=timeline,mentions&amp;username=#{@user.screen_name}&amp;api_key=GT-F181AC70B051&quot;</span>
			<span class="nv">headers: </span><span class="nx">header</span>
			<span class="nv">contentType: </span><span class="s2">&quot;text/plain&quot;</span>
			<span class="nv">dataType: </span><span class="s1">&#39;text&#39;</span>
			<span class="nv">data: </span><span class="s2">&quot;#{id},#{id}&quot;</span>
			<span class="nv">processData: </span><span class="kc">false</span>
			<span class="nv">error: </span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="o">=&gt;</span>
				<span class="nv">html = </span><span class="s2">&quot;</span>
<span class="s2">					&lt;div class=&#39;status&#39;&gt;</span>
<span class="s2">						&lt;b&gt;Fehler in setMaxReadID():&lt;/b&gt;&lt;br /&gt;</span>
<span class="s2">						Error #{req.status} (#{req.responseText})</span>
<span class="s2">					&lt;/div&gt;&quot;</span>
				<span class="nx">@add_html</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span>
		<span class="p">})</span>
		<span class="nx">@update_read_tweet_status</span><span class="p">()</span>
	</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Walks through all "new" tweets and marks them as read, if necessary.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">update_read_tweet_status: </span><span class="o">-&gt;</span>
		<span class="nv">elements = </span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#content_#{@id} .new&quot;</span><span class="p">)</span>
		<span class="k">for</span> <span class="nx">elm</span> <span class="k">in</span> <span class="nx">elements</span>
			<span class="nv">element = </span><span class="nx">$</span><span class="p">(</span><span class="nx">elm</span><span class="p">)</span>
			<span class="nx">element</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;new&#39;</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">@is_unread_tweet</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-tweet-id&#39;</span><span class="p">))</span>
		<span class="nx">@update_user_counter</span><span class="p">()</span>
	</pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Gets the current max<em>read</em>id from Tweetmarker. The request runs asynchronously
to prevent lockups in case of long reaction times of their site. So it
can take a few seconds to actually change the display of read and unread
tweets.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">get_max_read_id: </span><span class="o">-&gt;</span>
		<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#user_#{@id} .count&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;(?)&#39;</span><span class="p">)</span>
		</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Again OAuth echo stuff. For a better explanation please refer to
<code>set_max_read_id</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">header = </span><span class="p">{</span>
			<span class="s2">&quot;X-Auth-Service-Provider&quot;</span><span class="o">:</span> <span class="s2">&quot;https://api.twitter.com/1/account/verify_credentials.json&quot;</span>
			<span class="s2">&quot;X-Verify-Credentials-Authorization&quot;</span><span class="o">:</span> <span class="nx">@sign_request</span><span class="p">(</span><span class="s2">&quot;https://api.twitter.com/1/account/verify_credentials.json&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="nv">return_type: </span><span class="s2">&quot;header&quot;</span><span class="p">})</span>
		<span class="p">}</span>
		</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Ignore the mentions collection and just query </p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
			<span class="nv">method: </span><span class="s1">&#39;GET&#39;</span>
			<span class="nv">async: </span><span class="kc">true</span>
			<span class="nv">url: </span><span class="s2">&quot;proxy/tweetmarker/lastread?collection=timeline&amp;username=#{@user.screen_name}&amp;api_key=GT-F181AC70B051&quot;</span>
			<span class="nv">headers: </span><span class="nx">header</span>
			<span class="nv">dataType: </span><span class="s1">&#39;text&#39;</span>
			<span class="nv">success: </span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="o">=&gt;</span>
				<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="o">==</span><span class="mi">200</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="o">?</span>
					<span class="vi">@max_read_id = </span><span class="nx">data</span>
					<span class="nx">Application</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">@</span><span class="p">,</span> <span class="s2">&quot;get_max_read_id&quot;</span><span class="p">,</span> <span class="s2">&quot;result: #{data}&quot;</span><span class="p">)</span>
					<span class="nx">@update_read_tweet_status</span><span class="p">()</span>
		<span class="p">})</span>
		<span class="k">return</span>
	
	<span class="nv">toString: </span><span class="o">-&gt;</span> <span class="s2">&quot;Account #{@user.screen_name}&quot;</span>
	
	<span class="nv">get_content_div_id: </span><span class="o">-&gt;</span> <span class="s2">&quot;content_#{@id}&quot;</span>
	</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Validates the credentials of the current account and also gets some basic
data about this account (e.g. screen_name, id and so on).</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">validate_credentials: </span><span class="o">-&gt;</span>
		<span class="nx">@set_status</span><span class="p">(</span><span class="s2">&quot;Validating Credentials...&quot;</span><span class="p">,</span> <span class="s2">&quot;orange&quot;</span><span class="p">)</span>
		<span class="nx">@twitter_request</span><span class="p">(</span><span class="s1">&#39;account/verify_credentials.json&#39;</span><span class="p">,</span> <span class="p">{</span>
			<span class="nv">method: </span><span class="s2">&quot;GET&quot;</span>
			<span class="nv">silent: </span><span class="kc">true</span>
			<span class="nv">async: </span><span class="kc">true</span>
			<span class="nv">success: </span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
				<span class="nx">unless</span> <span class="nx">data</span><span class="p">.</span><span class="nx">screen_name</span>
					<span class="nx">@add_status_html</span><span class="p">(</span><span class="s2">&quot;Unknown error in validate_credentials. Exiting. #{data}&quot;</span><span class="p">)</span>
					<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#user_#{@id} img&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="s2">&quot;icons/exclamation.png&quot;</span><span class="p">)</span>
					<span class="k">return</span>
				<span class="vi">@user = </span><span class="k">new</span> <span class="nx">User</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
				<span class="vi">@screen_name = </span><span class="nx">@user</span><span class="p">.</span><span class="nx">screen_name</span>
				<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#user_#{@id} img&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">profile_image_url</span><span class="p">)</span>
				<span class="nx">@get_max_read_id</span><span class="p">()</span>
				<span class="nx">@get_followers</span><span class="p">()</span>
				<span class="nx">@fill_list</span><span class="p">()</span>
			<span class="nv">error: </span><span class="o">=&gt;</span>
				<span class="nx">@add_status_html</span><span class="p">(</span><span class="s2">&quot;Unknown error in validate_credentials. Exiting.&quot;</span><span class="p">)</span>
				<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#user_#{@id} img&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="s2">&quot;icons/exclamation.png&quot;</span><span class="p">)</span>
				<span class="nx">@set_status</span><span class="p">(</span><span class="s2">&quot;Error!&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">)</span>
		<span class="p">})</span>
	
	<span class="nv">get_followers: </span><span class="o">-&gt;</span> <span class="nx">@twitter_request</span><span class="p">(</span><span class="s1">&#39;followers/ids.json&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">silent: </span><span class="kc">true</span><span class="p">,</span> <span class="nv">method: </span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nv">success: </span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@followers_ids</span><span class="o">=</span><span class="nx">data</span><span class="p">.</span><span class="nx">ids</span><span class="p">})</span>
	<span class="nv">get_tweet: </span><span class="nf">(id) -&gt;</span> <span class="nx">@tweets</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
	</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Adds HTML code to this account's content area.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">add_html: </span><span class="nf">(html) -&gt;</span> 
		<span class="nv">element = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">)</span>
		<span class="nv">element.innerHTML = </span><span class="nx">html</span>
		<span class="nx">@get_my_element</span><span class="p">().</span><span class="nx">prepend</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span>
	</pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Adds a status message to this account's content area.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">add_status_html: </span><span class="nf">(message) -&gt;</span>
		<span class="nv">html = </span><span class="s2">&quot;</span>
<span class="s2">			&lt;div class=&#39;status&#39;&gt;</span>
<span class="s2">				#{message}</span>
<span class="s2">			&lt;/div&gt;&quot;</span>
		<span class="nx">@add_html</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span>
		<span class="k">return</span> <span class="s2">&quot;&quot;</span>
	</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Updates the number of unread tweets at the top of the page.
We count all unread tweets including mentions (even if they aren't)
visibly marked as new, but excluding my own tweets.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">update_user_counter: </span><span class="o">-&gt;</span>
		<span class="nv">count = </span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#content_#{@id} .tweet.new&quot;</span><span class="p">).</span><span class="o">not</span><span class="p">(</span><span class="s1">&#39;.by_this_user&#39;</span><span class="p">).</span><span class="nx">length</span>
		<span class="nv">str = </span><span class="k">if</span> <span class="nx">count</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">then</span> <span class="s2">&quot;(#{count})&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
		<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#user_#{@id} .count&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span>
	</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Decides if the given tweet can be considered unread or not.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">is_unread_tweet: </span><span class="nf">(tweet_id) -&gt;</span> <span class="nx">tweet_id</span><span class="p">.</span><span class="nx">is_bigger_than</span><span class="p">(</span><span class="nx">@max_read_id</span><span class="p">)</span>
	</pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Get the current twitter configuration (values like "short<em>link</em>length",
"max<em>photo</em>size" and so on). Gets called on the first account only by
Application at startup.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">get_twitter_configuration: </span><span class="o">-&gt;</span>
		<span class="nx">@twitter_request</span><span class="p">(</span><span class="s1">&#39;help/configuration.json&#39;</span><span class="p">,</span> <span class="p">{</span>
			<span class="nv">silent: </span><span class="kc">true</span>
			<span class="nv">async: </span><span class="kc">true</span>
			<span class="nv">method: </span><span class="s2">&quot;GET&quot;</span>
			<span class="nv">success: </span><span class="nf">(element, data) -&gt;</span> <span class="nv">Application.twitter_config = </span><span class="nx">data</span>
		<span class="p">})</span>
	</pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Signs a request to the Twitter API using the current account's keys.
<code>options</code> can contain following options:</p>

<ul>
<li><code>return_type</code>:
<ul><li><code>header</code>: Returns only the oauth_values in a form useful as header
value. Example: <code>oauth_key="abc", oauth_nonce="def", ...</code></li>
<li><code>parameters</code> (default): Returns all parameters as URLencoded string.
Example: <code>some_key=some_value&amp;oauth_key=abc&amp;oauth_nonce=def</code></li></ul></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">sign_request: </span><span class="nf">(url, method, parameters, options={}) -&gt;</span>
		<span class="nv">message = </span><span class="p">{</span>
			<span class="nv">action: </span><span class="nx">url</span>
			<span class="nv">method: </span><span class="nx">method</span>
			<span class="nv">parameters: </span><span class="nx">parameters</span>
		<span class="p">}</span>
		<span class="nx">OAuth</span><span class="p">.</span><span class="nx">setTimestampAndNonce</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
		<span class="nx">OAuth</span><span class="p">.</span><span class="nx">completeRequest</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">@keys</span><span class="p">)</span>
		<span class="nx">OAuth</span><span class="p">.</span><span class="nx">SignatureMethod</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">@keys</span><span class="p">)</span>
		
		<span class="k">switch</span> <span class="nx">options</span><span class="p">.</span><span class="nx">return_type</span>
			<span class="k">when</span> <span class="s2">&quot;header&quot;</span>
				<span class="k">return</span> <span class="p">(</span><span class="s2">&quot;#{key}=\&quot;#{value}\&quot;&quot;</span> <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">message</span><span class="p">.</span><span class="nx">parameters</span> <span class="k">when</span> <span class="nx">key</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;oauth&quot;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
			<span class="k">when</span> <span class="s2">&quot;parameters&quot;</span>
				<span class="k">return</span> <span class="nx">message</span><span class="p">.</span><span class="nx">parameters</span>
		<span class="k">return</span> <span class="nx">OAuth</span><span class="p">.</span><span class="nx">formEncode</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">parameters</span><span class="p">)</span>
	</pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Performs a request to the Twitter API. Valid options are:</p>

<ul>
<li><code>silent</code> (default: <code>false</code>): Set to true to skip all outputs. Use for background actions.</li>
<li><code>method</code> (default: <code>POST</code>): <code>POST</code> or <code>GET</code></li>
<li><code>parameters</code>: An object containing parameters for the request.</li>
<li><code>dataType</code> (default: <code>json</code>): The dataType to expect back.</li>
<li><code>async</code> (default: <code>true</code>): Whether to run asynchronously or not.</li>
<li><code>success_string</code>: String to show after request was successful.</li>
<li><code>success</code>: Function to be executed after request was successful.</li>
<li><code>error</code>: Function to be executed after the request either got an error
code back or the resulting de-JSON-ififed object contained an error.</li>
<li><code>return_response</code> (default <code>false</code>): Whether to return the responseText
after the request. Only useful if <code>async</code> was set to <code>false</code>.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">twitter_request: </span><span class="nf">(url, options) -&gt;</span>
		<span class="nv">method = </span><span class="nx">options</span><span class="p">.</span><span class="nx">method</span> <span class="o">?</span> <span class="s2">&quot;POST&quot;</span>
		<span class="nv">verbose = </span><span class="o">!</span><span class="p">(</span><span class="o">!!</span><span class="nx">options</span><span class="p">.</span><span class="nx">silent</span> <span class="o">&amp;&amp;</span> <span class="kc">true</span><span class="p">)</span>
		<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#form&#39;</span><span class="p">).</span><span class="nx">fadeTo</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="nx">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="k">if</span> <span class="nx">verbose</span>
		<span class="nv">data = </span><span class="nx">@sign_request</span><span class="p">(</span><span class="s2">&quot;https://api.twitter.com/1/#{url}&quot;</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">parameters</span><span class="p">)</span>
		<span class="nv">url = </span><span class="s2">&quot;proxy/api/#{url}&quot;</span>
		
		<span class="nv">result = </span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
			<span class="nv">url: </span><span class="nx">url</span>
			<span class="nv">data: </span><span class="nx">data</span>
			<span class="nv">dataType: </span><span class="nx">options</span><span class="p">.</span><span class="nx">dataType</span> <span class="o">?</span> <span class="s2">&quot;json&quot;</span>
			<span class="nv">async: </span><span class="nx">options</span><span class="p">.</span><span class="nx">async</span> <span class="o">?</span> <span class="kc">true</span>
			<span class="nv">type: </span><span class="nx">method</span>
			<span class="nv">success: </span><span class="nf">(data, textStatus, req) -&gt;</span>
				<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="o">==</span><span class="s2">&quot;200&quot;</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="o">==</span><span class="mi">200</span>
					<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#success_info&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">success_string</span><span class="p">)</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">success_string</span><span class="o">?</span>
					<span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#success_info&#39;</span><span class="p">),</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">additional_info</span><span class="p">)</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">success</span><span class="o">?</span>
					<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#success&#39;</span><span class="p">).</span><span class="nx">fadeIn</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">delay</span><span class="p">(</span><span class="mi">5000</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#form&#39;</span><span class="p">).</span><span class="nx">fadeTo</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="nx">verbose</span>
				<span class="k">else</span>
					<span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="o">?</span>
						<span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#failure_info&#39;</span><span class="p">),</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">additional_info</span><span class="p">)</span> 
					<span class="k">else</span>
						<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#failure_info&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span>
					<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#failure&#39;</span><span class="p">).</span><span class="nx">fadeIn</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">delay</span><span class="p">(</span><span class="mi">2000</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#form&#39;</span><span class="p">).</span><span class="nx">fadeTo</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="nx">verbose</span>
			<span class="nv">error: </span><span class="nf">(req, textStatus, exc) -&gt;</span>
				<span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="o">?</span>
					<span class="nx">options</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#failure_info&#39;</span><span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">exc</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">additional_info</span><span class="p">)</span>
				<span class="k">else</span>
					<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#failure_info&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;Error #{req.status} (#{req.statusText})&quot;</span><span class="p">)</span>
				<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#failure&#39;</span><span class="p">).</span><span class="nx">fadeIn</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">delay</span><span class="p">(</span><span class="mi">2000</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#form&#39;</span><span class="p">).</span><span class="nx">fadeTo</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="nx">verbose</span>
		<span class="p">})</span>
		<span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">responseText</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">return_response</span>
	
	<span class="nv">fill_list: </span><span class="o">=&gt;</span>
		<span class="nx">@set_status</span><span class="p">(</span><span class="s2">&quot;Filling List...&quot;</span><span class="p">,</span> <span class="s2">&quot;orange&quot;</span><span class="p">)</span>
		<span class="nv">threads_running = </span><span class="mi">5</span>
		<span class="nv">threads_errored = </span><span class="mi">0</span>
		<span class="nv">responses = </span><span class="p">[]</span>
		
		<span class="nv">after_run = </span><span class="o">=&gt;</span>
			<span class="k">if</span> <span class="nx">threads_errored</span> <span class="o">==</span> <span class="mi">0</span>
				<span class="nx">@set_status</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
				<span class="nx">@parse_data</span><span class="p">(</span><span class="nx">responses</span><span class="p">)</span>
				<span class="nx">@request</span><span class="p">.</span><span class="nx">start_request</span><span class="p">()</span> 
			<span class="k">else</span>
				<span class="nx">setTimeout</span><span class="p">(</span><span class="nx">@fill_list</span><span class="p">,</span> <span class="mi">30000</span><span class="p">)</span>
				<span class="nx">@add_status_html</span><span class="p">(</span><span class="s2">&quot;Fehler in fill_list.&lt;br /&gt;Nächster Versuch in 30 Sekunden.&quot;</span><span class="p">)</span>
		
		<span class="nv">success = </span><span class="nf">(element, data) -&gt;</span>
			<span class="nx">responses</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
			<span class="nx">threads_running</span> <span class="o">-=</span> <span class="mi">1</span>
			<span class="nx">after_run</span><span class="p">()</span> <span class="k">if</span> <span class="nx">threads_running</span> <span class="o">==</span> <span class="mi">0</span>
		
		<span class="nv">error = </span><span class="nf">(element, data) -&gt;</span>
			<span class="nx">threads_running</span> <span class="o">-=</span> <span class="mi">1</span>
			<span class="nx">threads_errored</span> <span class="o">+=</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>TODO: Dokumentation</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">after_run</span><span class="p">()</span> <span class="k">if</span> <span class="nx">threads_running</span> <span class="o">==</span> <span class="mi">0</span>
		
		<span class="nv">default_parameters = </span><span class="p">{</span>
			<span class="nv">include_rts: </span><span class="kc">true</span>
			<span class="nv">count: </span><span class="mi">200</span>
			<span class="nv">include_entities: </span><span class="kc">true</span>
			<span class="nv">page: </span><span class="mi">1</span>
			<span class="nv">since_id: </span><span class="nx">@max_known_tweet_id</span> <span class="nx">unless</span> <span class="nx">@max_known_tweet_id</span><span class="o">==</span><span class="s2">&quot;0&quot;</span>
		<span class="p">}</span>
		
		<span class="nv">requests = </span><span class="p">[</span>
			<span class="p">{</span>
				<span class="nv">url: </span><span class="s2">&quot;statuses/home_timeline.json&quot;</span>
				<span class="nv">name: </span><span class="s2">&quot;home_timeline 1&quot;</span>
			<span class="p">}</span>
			<span class="p">{</span>
				<span class="nv">url: </span><span class="s2">&quot;statuses/home_timeline.json&quot;</span>
				<span class="nv">name: </span><span class="s2">&quot;home_timeline 2&quot;</span>
				<span class="nv">extra_parameters: </span><span class="p">{</span><span class="nv">page: </span><span class="mi">2</span><span class="p">}</span>
			<span class="p">}</span>
			<span class="p">{</span>
				<span class="nv">url: </span><span class="s2">&quot;statuses/mentions.json&quot;</span>
				<span class="nv">name: </span><span class="s2">&quot;mentions&quot;</span>
			<span class="p">}</span>
			<span class="p">{</span>
				<span class="nv">url: </span><span class="s2">&quot;direct_messages.json&quot;</span>
				<span class="nv">name: </span><span class="s2">&quot;Received DMs&quot;</span>
				<span class="nv">extra_parameters: </span><span class="p">{</span>
					<span class="nv">count: </span><span class="mi">100</span>
					<span class="nv">since_id: </span><span class="nx">@max_known_dm_id</span> <span class="k">if</span> <span class="nx">@max_known_dm_id</span><span class="o">?</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="p">{</span>
				<span class="nv">url: </span><span class="s2">&quot;direct_messages/sent.json&quot;</span>
				<span class="nv">name: </span><span class="s2">&quot;Sent DMs&quot;</span>
				<span class="nv">extra_parameters: </span><span class="p">{</span>
					<span class="nv">count: </span><span class="mi">100</span>
					<span class="nv">since_id: </span><span class="nx">@max_known_dm_id</span> <span class="k">if</span> <span class="nx">@max_known_dm_id</span><span class="o">?</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">]</span>
		
		<span class="k">for</span> <span class="nx">request</span> <span class="k">in</span> <span class="nx">requests</span>
			<span class="nv">parameters = </span><span class="p">{}</span>
			<span class="nx">parameters</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span> <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">default_parameters</span> <span class="k">when</span> <span class="nx">value</span>
			<span class="nx">parameters</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span> <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">request</span><span class="p">.</span><span class="nx">extra_parameters</span> <span class="k">when</span> <span class="nx">value</span>
			<span class="nx">@twitter_request</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span>
				<span class="nv">method: </span><span class="s2">&quot;GET&quot;</span>
				<span class="nv">parameters: </span><span class="nx">parameters</span>
				<span class="nv">dataType: </span><span class="s2">&quot;text&quot;</span>
				<span class="nv">silent: </span><span class="kc">true</span>
				<span class="nv">additional_info: </span><span class="p">{</span><span class="nv">name: </span><span class="nx">request</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span>
				<span class="nv">success: </span><span class="nx">success</span>
				<span class="nv">error: </span><span class="nx">error</span>
			<span class="p">})</span>
	
	<span class="nv">parse_data: </span><span class="nf">(json) -&gt;</span> <span class="c1">#TODO</span>
		<span class="nv">json = </span><span class="p">[</span><span class="nx">json</span><span class="p">]</span> <span class="nx">unless</span> <span class="nx">json</span><span class="p">.</span><span class="nx">constructor</span><span class="o">==</span><span class="nb">Array</span>
		<span class="nv">responses = </span><span class="p">[]</span>
		<span class="k">for</span> <span class="nx">json_data</span> <span class="k">in</span> <span class="nx">json</span>
			<span class="k">try</span> <span class="nv">temp = </span><span class="nx">$</span><span class="p">.</span><span class="nx">parseJSON</span><span class="p">(</span><span class="nx">json_data</span><span class="p">)</span>
			<span class="k">continue</span> <span class="nx">unless</span> <span class="nx">temp</span><span class="o">?</span>
			<span class="k">if</span> <span class="nx">temp</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">==</span> <span class="nb">Array</span>
				<span class="nv">temp = </span><span class="nx">temp</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span>
				<span class="k">if</span> <span class="nx">temp</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">0</span>
					<span class="nv">temp_elements = </span><span class="p">[]</span>
					<span class="nx">temp_elements</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">TwitterMessage</span><span class="p">.</span><span class="nx">get_object</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="k">this</span><span class="p">))</span> <span class="k">for</span> <span class="nx">data</span> <span class="k">in</span> <span class="nx">temp</span>
					<span class="nx">responses</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">temp_elements</span><span class="p">)</span>
			<span class="k">else</span>
				<span class="nx">responses</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">TwitterMessage</span><span class="p">.</span><span class="nx">get_object</span><span class="p">(</span><span class="nx">temp</span><span class="p">,</span> <span class="k">this</span><span class="p">)])</span>
		<span class="k">return</span> <span class="k">if</span> <span class="nx">responses</span><span class="p">.</span><span class="nx">length</span><span class="o">==</span><span class="mi">0</span>
		
		<span class="nv">html = </span><span class="s2">&quot;&quot;</span>
		<span class="nv">last_id = </span><span class="s2">&quot;&quot;</span>
		<span class="k">while</span> <span class="nx">responses</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
			<span class="nv">oldest_date = </span><span class="kc">null</span>
			<span class="nv">oldest_index = </span><span class="kc">null</span>
			<span class="k">for</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">array</span> <span class="k">of</span> <span class="nx">responses</span>
				<span class="nv">object = </span><span class="nx">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">if</span> <span class="nx">oldest_date</span><span class="o">==</span><span class="kc">null</span> <span class="o">||</span> <span class="nx">object</span><span class="p">.</span><span class="nx">get_date</span><span class="p">()</span><span class="o">&lt;</span><span class="nx">oldest_date</span>
					<span class="nv">oldest_date = </span><span class="nx">object</span><span class="p">.</span><span class="nx">get_date</span><span class="p">()</span>
					<span class="nv">oldest_index = </span><span class="nx">index</span>
			<span class="nv">array = </span><span class="nx">responses</span><span class="p">[</span><span class="nx">oldest_index</span><span class="p">]</span>
			<span class="nv">object = </span><span class="nx">array</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
			<span class="nx">responses</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">oldest_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="o">==</span><span class="mi">0</span>
			<span class="nv">this_id = </span><span class="nx">object</span><span class="p">.</span><span class="nx">id</span>
			<span class="nv">html = </span><span class="nx">object</span><span class="p">.</span><span class="nx">get_html</span><span class="p">()</span> <span class="o">+</span> <span class="nx">html</span> <span class="nx">unless</span> <span class="nx">this_id</span><span class="o">==</span><span class="nx">old_id</span>
			<span class="k">if</span> <span class="nx">object</span><span class="p">.</span><span class="nx">constructor</span><span class="o">==</span><span class="nx">Tweet</span>
				<span class="nx">@max_known_tweet_id</span><span class="o">=</span><span class="nx">object</span><span class="p">.</span><span class="nx">id</span> <span class="k">if</span> <span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">is_bigger_than</span><span class="p">(</span><span class="nx">@max_known_tweet_id</span><span class="p">)</span>
				<span class="nx">@my_last_tweet_id</span><span class="o">=</span><span class="nx">object</span><span class="p">.</span><span class="nx">id</span> <span class="k">if</span> <span class="nx">object</span><span class="p">.</span><span class="nx">sender</span><span class="p">.</span><span class="nx">id</span><span class="o">==</span><span class="nx">@user</span><span class="p">.</span><span class="nx">id</span> <span class="o">&amp;&amp;</span> <span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">is_bigger_than</span><span class="p">(</span><span class="nx">@my_last_tweet_id</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">object</span><span class="p">.</span><span class="nx">constructor</span><span class="o">==</span><span class="nx">DirectMessage</span>
				<span class="nx">@max_known_dm_id</span><span class="o">=</span><span class="nx">object</span><span class="p">.</span><span class="nx">id</span> <span class="k">if</span> <span class="nx">object</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">is_bigger_than</span><span class="p">(</span><span class="nx">@max_known_dm_id</span><span class="p">)</span>
			<span class="nv">old_id = </span><span class="nx">this_id</span>
		<span class="nx">@add_html</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span>
		<span class="nx">@update_user_counter</span><span class="p">()</span>
	
	<span class="nv">scroll_to: </span><span class="nf">(tweet_id) -&gt;</span>
		<span class="nv">element_top = </span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;##{tweet_id}&quot;</span><span class="p">).</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Just scrolling to a tweet doesn't show it because it will be hidden behind
the form on the top. So we use this as an offset.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">topheight = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#content_template&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;padding-top&quot;</span><span class="p">))</span>
		<span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">scrollTop</span><span class="p">(</span><span class="nx">element_top</span> <span class="o">-</span> <span class="nx">topheight</span><span class="p">);</span>
		<span class="k">return</span> <span class="kc">false</span>
	
	<span class="nv">activate: </span><span class="o">-&gt;</span>
		<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.content&#39;</span><span class="p">).</span><span class="nx">hide</span><span class="p">()</span>
		<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#content_#{@id}&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">()</span>
		<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#users .user&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">)</span>
		<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#user_#{@id}&quot;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">)</span>
		<span class="nv">Application.current_account = </span><span class="k">this</span>
	
	<span class="nv">set_status: </span><span class="nf">(message, color) -&gt;</span>
		<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#user_#{@id}&quot;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;red green yellow orange&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">color</span><span class="p">)</span>
		<span class="vi">@status_text = </span><span class="nx">message</span>
	
	<span class="vi">@hooks: </span><span class="p">{</span>
		<span class="nv">change_current_account: </span><span class="nf">(elm) -&gt;</span>
			<span class="nv">account_id = </span><span class="nx">$</span><span class="p">(</span><span class="nx">elm</span><span class="p">).</span><span class="nx">parents</span><span class="p">(</span><span class="s1">&#39;.user&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;account-id&#39;</span><span class="p">)</span>
			<span class="nv">acct = </span><span class="nx">Application</span><span class="p">.</span><span class="nx">accounts</span><span class="p">[</span><span class="nx">account_id</span><span class="p">]</span>
			<span class="nx">acct</span><span class="p">.</span><span class="nx">activate</span><span class="p">()</span>
			<span class="k">return</span> <span class="kc">false</span>
		
		<span class="nv">mark_as_read: </span><span class="nf">(elm) -&gt;</span>
			<span class="nv">elements = </span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#content_#{Application.current_account.id} .tweet.new&quot;</span><span class="p">)</span>
			<span class="nv">id = </span><span class="kc">null</span>
			<span class="nv">offset = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">scrollTop</span><span class="p">()</span> <span class="o">+</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#top&#39;</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span>
			<span class="k">for</span> <span class="nx">element</span> <span class="k">in</span> <span class="nx">elements</span>
				<span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span> <span class="o">&gt;=</span> <span class="nx">offset</span>
					<span class="nv">id = </span><span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-tweet-id&#39;</span><span class="p">)</span>
					<span class="k">break</span>
			<span class="nx">Application</span><span class="p">.</span><span class="nx">current_account</span><span class="p">.</span><span class="nx">set_max_read_id</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">false</span>
		
		<span class="nv">goto_my_last_tweet: </span><span class="o">-&gt;</span>
			<span class="nx">Application</span><span class="p">.</span><span class="nx">current_account</span><span class="p">.</span><span class="nx">scroll_to</span><span class="p">(</span><span class="nx">Application</span><span class="p">.</span><span class="nx">current_account</span><span class="p">.</span><span class="nx">my_last_tweet_id</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">false</span>
		
		<span class="nv">goto_unread_tweet: </span><span class="o">-&gt;</span>
			<span class="nx">Application</span><span class="p">.</span><span class="nx">current_account</span><span class="p">.</span><span class="nx">scroll_to</span><span class="p">(</span><span class="nx">Application</span><span class="p">.</span><span class="nx">current_account</span><span class="p">.</span><span class="nx">max_read_id</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">false</span>
		
		<span class="nv">reload: </span><span class="o">-&gt;</span>
			<span class="nx">Application</span><span class="p">.</span><span class="nx">current_account</span><span class="p">.</span><span class="nx">get_max_read_id</span><span class="p">()</span>
			<span class="nx">Application</span><span class="p">.</span><span class="nx">current_account</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">restart</span><span class="p">()</span>
			<span class="k">return</span> <span class="kc">false</span>
	<span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 